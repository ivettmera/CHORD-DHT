# Build stage
FROM golang:1.21-alpine AS builder

# Install required packages
RUN apk add --no-cache git protobuf-dev

# Install protoc-gen-go and protoc-gen-go-grpc
RUN go install google.golang.org/protobuf/cmd/protoc-gen-go@latest
RUN go install google.golang.org/grpc/cmd/protoc-gen-go-grpc@latest

# Set working directory
WORKDIR /app

# Copy go mod files
COPY go.mod go.sum ./

# Download dependencies
RUN go mod download

# Copy source code
COPY . .

# Generate protobuf code
RUN chmod +x generate.sh && ./generate.sh

# Build the applications
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o node ./cmd/node
RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o simulator ./cmd/simulator

# Runtime stage
FROM alpine:latest

# Install ca-certificates for SSL/TLS
RUN apk --no-cache add ca-certificates

# Create non-root user
RUN addgroup -g 1001 chord && \
    adduser -D -s /bin/sh -u 1001 -G chord chord

# Set working directory
WORKDIR /app

# Copy binaries from builder stage
COPY --from=builder /app/node .
COPY --from=builder /app/simulator .

# Create results directory
RUN mkdir -p results && chown -R chord:chord /app

# Switch to non-root user
USER chord

# Expose default port
EXPOSE 5000

# Default command (can be overridden)
CMD ["./node", "--addr=0.0.0.0:5000"]